<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>Blackbox Targets Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .header {
      background-color: #fff;
      padding: 15px 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header-title {
      color: #007bff;
      margin: 0;
      font-size: 24px;
    }
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .header-button {
      background-color: #007bff;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }
<<<<<<< HEAD
<<<<<<< HEAD

    .header-button.generate {
      background-color: #28a745;
    }

    .header-button.primary {
      background-color: #007bff;
    }

    .header-button:hover {
      opacity: 0.9;
    }
    .button-danger {
        background-color: #dc3545 !important;
    }
    .button-danger:hover {
        background-color: #c82333 !important;
    }

    /* User Dropdown */
    .user-dropdown {
        position: relative;
        display: inline-block;
    }

    .user-dropdown .user-button {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f1f1f1;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
        right: 0;
        border-radius: 5px;
    }

    .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .dropdown-content a:hover {
        background-color: #ddd;
    }

    .dropdown-content.show {
        display: block;
    }

    /* Add Target Options styles */
    .add-target-options {
      display: flex;
      gap: 20px;
      padding: 20px 0;
    }

    .option-card {
      flex: 1;
      background-color: #f8f9fa;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .option-card:hover {
      border-color: #007bff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.1);
    }

    .option-card i {
      font-size: 2.5em;
      color: #007bff;
      margin-bottom: 15px;
    }

    .option-card h3 {
      color: #343a40;
      margin: 10px 0;
      font-size: 1.2em;
    }

    .option-card p {
      color: #6c757d;
      margin: 0;
      font-size: 0.9em;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1100;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 1200px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 12px;
    }

    .preview-table th {
      background-color: #f8f9fa;
      padding: 8px;
      text-align: left;
      border: 1px solid #dee2e6;
      color: #495057;
    }

    .preview-table th:hover {
      background-color: #e9ecef;
      color: #495057;
    }

    .preview-table td {
      padding: 8px;
      border: 1px solid #dee2e6;
    }

    .preview-table tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .preview-section {
      margin-top: 20px;
      border-top: 1px solid #dee2e6;
      padding-top: 20px;
    }

    .validation-message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
    }

    .validation-message.error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .validation-message.success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .import-summary {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
    }

    .import-summary h4 {
      margin: 0 0 10px 0;
      color: #495057;
    }

    .import-summary .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .import-summary .stat-item {
      flex: 1;
      text-align: center;
    }

    .import-summary .stat-number {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .import-summary .stat-label {
      color: #6c757d;
      font-size: 14px;
    }

    .import-summary .success {
      color: #28a745;
    }

    .import-summary .error {
      color: #dc3545;
    }

    .import-summary .error-list {
      margin-top: 10px;
      font-size: 14px;
      color: #721c24;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 4px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .import-summary .error-list .error-item {
      margin-bottom: 5px;
      padding-left: 20px;
      position: relative;
    }

    .import-summary .error-list .error-item:before {
      content: "â€¢";
      position: absolute;
      left: 8px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      margin: 0;
      color: #007bff;
    }

    .close-modal {
      font-size: 24px;
      font-weight: bold;
      color: #666;
      cursor: pointer;
      border: none;
      background: none;
      padding: 0;
    }

    .close-modal:hover {
      color: #333;
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .main-content {
      padding: 0 20px 80px;
    }
    h1, h2 {
      text-align: center;
      color: #007bff;
    }

    #addTargetForm {
      display: grid;
      grid-template-columns: repeat(6, 1fr); /* 5 columns per row */
      gap: 10px;
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    /* Modal form layout - vertical form */
    .modal #addTargetForm {
      display: flex;
      flex-direction: column;
      gap: 15px;
      grid-template-columns: none;
      max-width: none;
    }

    .modal #addTargetForm input,
    .modal #addTargetForm select,
    .modal #addTargetForm button {
      width: 100%;
      box-sizing: border-box;
    }

    #addTargetForm.highlight {
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
      animation: pulse 2s;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.5); }
      70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
    }

    #addTargetForm button {
      grid-column: span 1; /* Make the button take full width */
    }

    input, select, button {
      padding: 8px 8px;
      font-size: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
      transition: all 0.2s ease-in-out;
    }

    input:focus, select:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      border: none;
    }

    button:hover {
      background-color: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 5px 5px;
      padding-left: 20px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
      position: relative;
    }

    th:last-child {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: default;
    }

    th:hover {
      background-color: #0056b3;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    .selected-row {
        background-color: #d4edda !important; /* A light green to indicate selection */
    }

    #context-menu {
        display: none;
        position: absolute;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1200;
        padding: 5px 0;
    }

    #context-menu ul {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    #context-menu li {
        padding: 8px 15px;
        cursor: pointer;
    }

    #context-menu li:hover {
        background-color: #f8f9fa;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .status-enabled {
      color: green;
      font-weight: bold;
    }

    .status-disabled {
      color: red;
      font-weight: bold;
    }

    .import-section {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      background-color: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .import-section input[type="file"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 12px;
    }

    .import-section button {
      background-color: #17a2b8;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    .import-section button:hover {
      background-color: #138496;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .action-buttons button {
      padding: 5px 10px;
      font-size: 12px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 15px;
      background-color: #fff;
      border-top: 1px solid #dee2e6;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .footer-info {
      display: flex;
      justify-content: center;
      gap: 40px;
      padding: 0 20px;
      font-size: 14px;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
    }

    .footer-info div {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .footer-info div span {
      font-weight: bold;
    }

    .enabled {
      color: green;
      font-weight: bold;
    }

    .disabled {
      color: red;
      font-weight: bold;
    }

    #searchInput {
      padding: 8px 12px;
      font-size: 12px;
      border: 1px solid #007bff;
      border-radius: 5px;
      width: 300px;
      margin-right: 10px;
    }

    #searchInput:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    table {
        font-size: 14px;
    }
    .table-filter-button {
      background: none;
      border: none;
      color: white;
      padding: 4px 8px;
      cursor: pointer;
      float: right;
      transition: opacity 0.2s;
    }

    .table-filter-button:hover {
      opacity: 0.8;
    }

    .table-filter-button i {
      font-size: 14px;
    }

    #hideColumnsCheckboxes {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 200px;
      display: none;
    }

    #hideColumnsCheckboxes {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 200px;
      margin-top: 5px;
    }

    #hideColumnsCheckboxes.show {
      display: block;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      padding: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-radius: 4px;
    }

    .checkbox-label:hover {
      background-color: #f8f9fa;
    }

    .checkbox-label input {
      margin-right: 8px;
      cursor: pointer;
    }

    /* Toast Container */
    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    /* Toast Notification */
    .toast {
      background-color: #333;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 10px;
      min-width: 250px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: slideIn 0.5s ease-out;
    }

    .toast.error {
        background-color: #dc3545;
    }
    .toast.success {
        background-color: #28a745;
    }
    .toast.unsaved {
      background-color: #f0ad4e;
      color: black;
    }

    .toast .toast-content {
      flex-grow: 1;
    }

    .toast .toast-buttons {
      display: flex;
      gap: 8px;
      margin-left: 15px;
    }

    .toast button {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background-color: rgba(255, 255, 255, 0.9);
      color: #333;
    }

    .toast button:hover {
      background-color: white;
    }

    .toast-close-button {
        background: none;
        border: none;
        color: inherit;
        font-size: 24px;
        cursor: pointer;
        padding: 0 5px;
        margin-left: 15px;
        line-height: 1;
        opacity: 0.7;
    }

    .toast-close-button:hover {
        opacity: 1;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

=======
=======
>>>>>>> 53f13ebda89e6d6460280047d74ee3b7b91b3a8c
    .header-button.generate { background-color: #28a745; }
    .header-button.primary { background-color: #007bff; }
    .header-button:hover { opacity: 0.9; }
    .button-danger { background-color: #dc3545 !important; }
    .button-danger:hover { background-color: #c82333 !important; }
    .user-dropdown { position: relative; display: inline-block; }
    .user-dropdown .user-button { display: flex; align-items: center; gap: 5px; }
    .dropdown-content { display: none; position: absolute; background-color: #f1f1f1; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; right: 0; border-radius: 5px; }
    .dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; }
    .dropdown-content a:hover { background-color: #ddd; }
    .dropdown-content.show { display: block; }
    .modal { display: none; position: fixed; z-index: 1100; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 1200px; position: relative; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { margin: 0; color: #007bff; }
    .close-modal { font-size: 24px; font-weight: bold; color: #666; cursor: pointer; border: none; background: none; padding: 0; }
    .close-modal:hover { color: #333; }
    .modal-body { margin-bottom: 20px; }
    .main-content { padding: 0 20px 80px; }
    table { width: 100%; border-collapse: collapse; background-color: #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 10px; overflow: hidden; }
    th, td { padding: 5px 5px; padding-left: 20px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #007bff; color: white; }
    .preview-section { margin-top: 20px; border-top: 1px solid #dee2e6; padding-top: 20px; }
    .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .preview-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
    .preview-table th, .preview-table td { padding: 8px; border: 1px solid #dee2e6; }
    .no-data-message { text-align: center; padding: 50px; color: #6c757d; font-size: 18px; }
    #idleWarningModal .modal-header { justify-content: center; }
    #idleWarningModal .modal-body { text-align: center; }
    #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 1200; }
    .toast { background-color: #333; color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 10px; min-width: 250px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); animation: slideIn 0.5s ease-out; }
    .toast.error { background-color: #dc3545; }
    .toast.success { background-color: #28a745; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
<<<<<<< HEAD
>>>>>>> 53f13ebda89e6d6460280047d74ee3b7b91b3a8c
=======
>>>>>>> 53f13ebda89e6d6460280047d74ee3b7b91b3a8c
  </style>
</head>
<body>
  <div id="toastContainer"></div>
  <div class="header">
    <h1 class="header-title">Blackbox Targets Manager</h1>
    <div class="header-actions">
<<<<<<< HEAD
<<<<<<< HEAD
      <input type="text" id="searchInput" placeholder="Type anything to search targets...">
      {% if user_role == 'admin' %}
      <button onclick="openAddTargetModal()" class="header-button primary">
        <i class="fas fa-plus"></i> Add Target
      </button>
      <button onclick="saveChanges()" class="header-button generate">Save & Generate YAML</button>
      {% endif %}
=======
>>>>>>> 53f13ebda89e6d6460280047d74ee3b7b91b3a8c
=======
>>>>>>> 53f13ebda89e6d6460280047d74ee3b7b91b3a8c
      <div class="user-dropdown">
        <button class="header-button user-button"><i class="fas fa-user"></i> {{ username }} <i class="fas fa-caret-down"></i></button>
        <div class="dropdown-content">
            <a href="/settings" id="settingsLink">Settings</a>
            <a href="/users" id="userManagementLink">User Management</a>
            <a href="#" id="exportLink">Export</a>
        </div>
      </div>
      <a href="/logout" class="header-button button-danger" style="text-decoration: none;"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
  </div>

  <div class="main-content">
    <div id="noDataMessage" class="no-data-message" style="display: none;">No targets found.</div>
    <table id="targetsTable">
      <thead>
          <tr>
            <th>Prober</th><th>Target</th><th>Module</th><th>Zone</th><th>Service</th><th>Device</th><th>Connection Type</th><th>Location</th><th>Short Name</th><th>Status</th><th>Actions</th>
          </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Idle Timeout Warning Modal -->
  <div id="idleWarningModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">Session Timeout Warning</h2>
      </div>
      <div class="modal-body">
        <p>You will be logged out in <span id="idleWarningCountdown">60</span> seconds due to inactivity.</p>
        <p>Click the button below to stay logged in.</p>
      </div>
      <div class="modal-footer" style="text-align: center; margin-top: 20px;">
        <button id="stayLoggedInBtn" class="header-button generate">Stay Logged In</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Export Targets</h2>
        <button class="close-modal" id="closeExportModal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="filter-builder">
          <h4>Filters</h4>
          <div id="filter-rows"></div>
          <button id="addFilterBtn" class="header-button primary" style="margin-top: 10px;"><i class="fas fa-plus"></i> Add Filter</button>
        </div>
        <div class="preview-section">
          <div class="preview-header">
              <h4>Preview</h4>
              <div>
                  <span>Show:</span>
                  <select id="previewRowCount" style="margin-left: 5px;">
                      <option value="5">5</option><option value="10">10</option><option value="50">50</option><option value="100">100</option>
                  </select>
              </div>
          </div>
          <div style="overflow-x: auto;">
              <table id="exportPreviewTable" class="preview-table">
                  <thead></thead>
                  <tbody></tbody>
              </table>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="text-align: right; margin-top: 20px;">
        <button id="exportCsvBtn" class="header-button generate"><i class="fas fa-file-csv"></i> Export as CSV</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const userRole = '{{ user_role }}';
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.5s ease-out forwards';
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }
<<<<<<< HEAD

        const userDropdown = document.querySelector('.user-dropdown');
        userButton = userDropdown.querySelector('.user-button');
        dropdownContent = userDropdown.querySelector('.dropdown-content');
        userButton.addEventListener('click', (e) => { e.stopPropagation(); dropdownContent.classList.toggle('show'); });
        window.addEventListener('click', () => { if (dropdownContent.classList.contains('show')) dropdownContent.classList.remove('show'); });
        if (userRole !== 'admin') {
            ['settingsLink', 'userManagementLink'].forEach(id => {
                document.getElementById(id).addEventListener('click', (e) => {
                    e.preventDefault();
                    showToast('Access Denied: You do not have permission to view this page.', 'error');
                });
            });
        }

        const table = document.getElementById('targetsTable');
        const noDataMessage = document.getElementById('noDataMessage');
        const tbody = table.querySelector('tbody');
        async function loadTargets() {
            try {
                const response = await fetch('/targets');
                const targets = await response.json();
                tbody.innerHTML = '';
                if (targets.length === 0) {
                    table.style.display = 'none';
                    noDataMessage.style.display = 'block';
                } else {
                    table.style.display = 'table';
                    noDataMessage.style.display = 'none';
                }
            } catch (error) {
                table.style.display = 'none';
                noDataMessage.textContent = 'Error loading data.';
                noDataMessage.style.display = 'block';
            }
        }
        loadTargets();

        const exportModal = document.getElementById('exportModal');
        const exportLink = document.getElementById('exportLink');
        const closeExportModalBtn = document.getElementById('closeExportModal');
        const addFilterBtn = document.getElementById('addFilterBtn');
        const filterRowsContainer = document.getElementById('filter-rows');
        const previewRowCountSelect = document.getElementById('previewRowCount');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const previewTableHead = document.querySelector('#exportPreviewTable thead');
        const previewTableBody = document.querySelector('#exportPreviewTable tbody');
        const tableHeaders = ['address', 'instance', 'module', 'zone', 'service', 'device_type', 'connection_type', 'location', 'short_name', 'enabled'];
        let filteredData = [];

        function createFilterRow() {
            const row = document.createElement('div');
            row.className = 'filter-row';
            row.style.cssText = 'display:flex; gap:10px; margin-bottom:10px;';
            row.innerHTML = `<select class="filter-field">${tableHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}</select><select class="filter-operator"><option>==</option><option>!=</option><option>~=</option></select><input type="text" class="filter-value" placeholder="Value"><button class="header-button button-danger"><i class="fas fa-trash"></i></button>`;
            row.querySelector('button').onclick = () => { row.remove(); updatePreview(); };
            row.querySelectorAll('select, input').forEach(el => {
                el.onchange = updatePreview;
                if(el.tagName === 'INPUT') el.oninput = updatePreview;
            });
            filterRowsContainer.appendChild(row);
        }

        async function updatePreview() {
            const filters = Array.from(filterRowsContainer.children).map(r => ({ field: r.querySelector('.filter-field').value, operator: r.querySelector('.filter-operator').value, value: r.querySelector('.filter-value').value })).filter(f => f.value);
            try {
                const response = await fetch('/api/export/preview', { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken}, body: JSON.stringify({ filters }) });
                if (!response.ok) throw new Error('Failed to fetch preview');
                filteredData = await response.json();
                renderPreviewTable();
            } catch (error) { showToast('Error fetching preview.', 'error'); }
        }

        function renderPreviewTable() {
            previewTableHead.innerHTML = `<tr>${tableHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
            previewTableBody.innerHTML = '';
            const dataToShow = filteredData.slice(0, parseInt(previewRowCountSelect.value, 10));
            if (dataToShow.length === 0) {
                previewTableBody.innerHTML = `<tr><td colspan="${tableHeaders.length}" style="text-align: center;">No matching targets.</td></tr>`;
                return;
            }
            dataToShow.forEach(target => {
                const row = document.createElement('tr');
                row.innerHTML = tableHeaders.map(h => `<td>${target[h] !== undefined ? target[h] : ''}</td>`).join('');
                previewTableBody.appendChild(row);
            });
        }

        function exportToCsv() {
            if (filteredData.length === 0) return showToast('No data to export.', 'error');
            const delimiter = ';';
            const headers = tableHeaders.join(delimiter);
            const rows = filteredData.map(target => tableHeaders.map(h => {
                const val = String(target[h] !== undefined ? target[h] : '');
                return val.includes(delimiter) || val.includes('"') ? `"${val.replace(/"/g, '""')}"` : val;
            }).join(delimiter));
            const csv = [headers, ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'blackbox-targets.csv';
            link.click();
        }

        exportLink.addEventListener('click', (e) => { e.preventDefault(); exportModal.style.display = 'block'; updatePreview(); });
        closeExportModalBtn.addEventListener('click', () => { exportModal.style.display = 'none'; });
        addFilterBtn.addEventListener('click', createFilterRow);
        previewRowCountSelect.addEventListener('change', renderPreviewTable);
        exportCsvBtn.addEventListener('click', exportToCsv);

        // --- Idle Lockout Logic ---
        let idleTimer, warningTimer, countdownTimer;
        const idleTimeoutMinutes = {{ idle_timeout }};
        const idleWarningModal = document.getElementById('idleWarningModal');
        const stayLoggedInBtn = document.getElementById('stayLoggedInBtn');
        const countdownSpan = document.getElementById('idleWarningCountdown');

        function startIdleWarning() {
            let count = 60;
            countdownSpan.textContent = count;
            idleWarningModal.style.display = 'block';
            countdownTimer = setInterval(() => {
                count--;
                countdownSpan.textContent = count;
                if (count <= 0) window.location.href = '/logout';
            }, 1000);
        }

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            clearTimeout(warningTimer);
            clearInterval(countdownTimer);
            idleWarningModal.style.display = 'none';
            const timeoutMs = idleTimeoutMinutes * 60 * 1000;
            if (timeoutMs > 60000) {
                warningTimer = setTimeout(startIdleWarning, timeoutMs - 60000);
            }
            idleTimer = setTimeout(() => window.location.href = '/logout', timeoutMs);
        }

        stayLoggedInBtn.addEventListener('click', resetIdleTimer);
        ['click', 'keypress'].forEach(evt => window.addEventListener(evt, resetIdleTimer));
        resetIdleTimer();
        window.addEventListener('click', (event) => { if (event.target == exportModal) exportModal.style.display = 'none'; });
    });
  </script>

  <!-- Idle Timeout Warning Modal -->
  <div id="idleWarningModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <div class="modal-header">
        <h2 class="modal-title">Session Timeout Warning</h2>
      </div>
      <div class="modal-body">
        <p>You will be logged out in <span id="idleWarningCountdown">60</span> seconds due to inactivity.</p>
        <p>Click the button below to stay logged in.</p>
      </div>
      <div class="modal-footer" style="text-align: center; margin-top: 20px;">
        <button id="stayLoggedInBtn" class="header-button generate">Stay Logged In</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Export Targets</h2>
        <button class="close-modal" id="closeExportModal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="filter-builder">
          <h4>Filters</h4>
          <div id="filter-rows">
            <!-- Filter rows will be added here dynamically -->
          </div>
          <button id="addFilterBtn" class="header-button primary" style="margin-top: 10px;"><i class="fas fa-plus"></i> Add Filter</button>
        </div>
        <div class="preview-section" style="margin-top: 20px;">
          <h4>Preview</h4>
          <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px;">
            <span>Show:</span>
            <select id="previewRowCount" style="margin-left: 5px;">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
          <div style="overflow-x: auto;">
            <table id="exportPreviewTable" class="preview-table">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="text-align: right; margin-top: 20px;">
        <button id="exportCsvBtn" class="header-button generate"><i class="fas fa-file-csv"></i> Export as CSV</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Main Page Logic ---
        const userRole = '{{ user_role }}';
        let targets = [];
        let currentEditingId = null;
        let selectedTargetIds = [];
        let lastSelectedRowId = null;
        let hasUnsavedChanges = false;
        let unsavedToast = null;
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // --- Dropdown Elements & Logic ---
        const userDropdown = document.querySelector('.user-dropdown');
        const userButton = userDropdown.querySelector('.user-button');
        const dropdownContent = userDropdown.querySelector('.dropdown-content');
        const settingsLink = document.getElementById('settingsLink');
        const userManagementLink = document.getElementById('userManagementLink');
        const exportLink = document.getElementById('exportLink');

        userButton.addEventListener('click', (event) => {
            event.stopPropagation();
            dropdownContent.classList.toggle('show');
        });

        window.addEventListener('click', (event) => {
            if (!userDropdown.contains(event.target)) {
                if (dropdownContent.classList.contains('show')) {
                    dropdownContent.classList.remove('show');
                }
            }
        });
=======
>>>>>>> 53f13ebda89e6d6460280047d74ee3b7b91b3a8c

        const userDropdown = document.querySelector('.user-dropdown');
        userButton = userDropdown.querySelector('.user-button');
        dropdownContent = userDropdown.querySelector('.dropdown-content');
        userButton.addEventListener('click', (e) => { e.stopPropagation(); dropdownContent.classList.toggle('show'); });
        window.addEventListener('click', () => { if (dropdownContent.classList.contains('show')) dropdownContent.classList.remove('show'); });
        if (userRole !== 'admin') {
<<<<<<< HEAD
            const handleAccessDenied = (e) => {
                e.preventDefault();
                showToast('Access Denied: You do not have permission to view this page.', 'error');
            };
            settingsLink.addEventListener('click', handleAccessDenied);
            userManagementLink.addEventListener('click', handleAccessDenied);
        }

        // --- Export Modal Elements & Logic ---
        const exportModal = document.getElementById('exportModal');
        const closeExportModalBtn = document.getElementById('closeExportModal');
        const addFilterBtn = document.getElementById('addFilterBtn');
        const filterRowsContainer = document.getElementById('filter-rows');
        const previewTable = document.getElementById('exportPreviewTable');
        const previewTableHead = previewTable.querySelector('thead');
        const previewTableBody = previewTable.querySelector('tbody');
        const previewRowCountSelect = document.getElementById('previewRowCount');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const tableHeaders = [
            'address', 'instance', 'module', 'zone', 'service',
            'device_type', 'connection_type', 'location', 'short_name', 'enabled'
        ];
=======
            ['settingsLink', 'userManagementLink'].forEach(id => {
                document.getElementById(id).addEventListener('click', (e) => {
                    e.preventDefault();
                    showToast('Access Denied: You do not have permission to view this page.', 'error');
                });
            });
        }

        const table = document.getElementById('targetsTable');
        const noDataMessage = document.getElementById('noDataMessage');
        const tbody = table.querySelector('tbody');
        async function loadTargets() {
            try {
                const response = await fetch('/targets');
                const targets = await response.json();
                tbody.innerHTML = '';
                if (targets.length === 0) {
                    table.style.display = 'none';
                    noDataMessage.style.display = 'block';
                } else {
                    table.style.display = 'table';
                    noDataMessage.style.display = 'none';
                }
            } catch (error) {
                table.style.display = 'none';
                noDataMessage.textContent = 'Error loading data.';
                noDataMessage.style.display = 'block';
            }
        }
        loadTargets();

        const exportModal = document.getElementById('exportModal');
        const exportLink = document.getElementById('exportLink');
        const closeExportModalBtn = document.getElementById('closeExportModal');
        const addFilterBtn = document.getElementById('addFilterBtn');
        const filterRowsContainer = document.getElementById('filter-rows');
        const previewRowCountSelect = document.getElementById('previewRowCount');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const previewTableHead = document.querySelector('#exportPreviewTable thead');
        const previewTableBody = document.querySelector('#exportPreviewTable tbody');
        const tableHeaders = ['address', 'instance', 'module', 'zone', 'service', 'device_type', 'connection_type', 'location', 'short_name', 'enabled'];
>>>>>>> 53f13ebda89e6d6460280047d74ee3b7b91b3a8c
        let filteredData = [];

        function createFilterRow() {
            const row = document.createElement('div');
            row.className = 'filter-row';
<<<<<<< HEAD
            row.style.display = 'flex';
            row.style.gap = '10px';
            row.style.marginBottom = '10px';

            const fieldSelect = document.createElement('select');
            fieldSelect.className = 'filter-field';
            tableHeaders.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                fieldSelect.appendChild(option);
            });
            fieldSelect.onchange = updatePreview;

            const operatorSelect = document.createElement('select');
            operatorSelect.className = 'filter-operator';
            ['==', '!=', '~='].forEach(op => {
                const option = document.createElement('option');
                option.value = op;
                option.textContent = op;
                operatorSelect.appendChild(option);
            });
            operatorSelect.onchange = updatePreview;

            const valueInput = document.createElement('input');
            valueInput.className = 'filter-value';
            valueInput.type = 'text';
            valueInput.placeholder = 'Value';
            valueInput.oninput = updatePreview;

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
            removeBtn.className = 'header-button button-danger';
            removeBtn.onclick = () => {
                row.remove();
                updatePreview();
            };

            row.append(fieldSelect, operatorSelect, valueInput, removeBtn);
=======
            row.style.cssText = 'display:flex; gap:10px; margin-bottom:10px;';
            row.innerHTML = `<select class="filter-field">${tableHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}</select><select class="filter-operator"><option>==</option><option>!=</option><option>~=</option></select><input type="text" class="filter-value" placeholder="Value"><button class="header-button button-danger"><i class="fas fa-trash"></i></button>`;
            row.querySelector('button').onclick = () => { row.remove(); updatePreview(); };
            row.querySelectorAll('select, input').forEach(el => {
                el.onchange = updatePreview;
                if(el.tagName === 'INPUT') el.oninput = updatePreview;
            });
>>>>>>> 53f13ebda89e6d6460280047d74ee3b7b91b3a8c
            filterRowsContainer.appendChild(row);
        }

        async function updatePreview() {
<<<<<<< HEAD
            const filters = [];
            filterRowsContainer.querySelectorAll('.filter-row').forEach(row => {
                const field = row.querySelector('.filter-field').value;
                const operator = row.querySelector('.filter-operator').value;
                const value = row.querySelector('.filter-value').value;
                if (value) {
                    filters.push({ field, operator, value });
                }
            });

            try {
                const response = await fetch('/api/export/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ filters })
                });
                if (!response.ok) throw new Error('Failed to fetch preview');
                filteredData = await response.json();
                renderPreviewTable();
            } catch (error) {
                console.error('Error fetching preview:', error);
                showToast('An error occurred while fetching preview data.', 'error');
            }
        }

        function renderPreviewTable() {
            previewTableHead.innerHTML = '';
            previewTableBody.innerHTML = '';

            if (filteredData.length === 0) {
                previewTableBody.innerHTML = `<tr><td colspan="${tableHeaders.length}" style="text-align: center;">No matching targets found.</td></tr>`;
                return;
            }

            const headerRow = document.createElement('tr');
            tableHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            previewTableHead.appendChild(headerRow);

            const rowCount = parseInt(previewRowCountSelect.value, 10);
            const dataToShow = filteredData.slice(0, rowCount);

            dataToShow.forEach(target => {
                const row = document.createElement('tr');
                tableHeaders.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = target[header] !== undefined ? target[header] : '';
                    row.appendChild(td);
                });
                previewTableBody.appendChild(row);
            });
        }

        function exportToCsv() {
            if (filteredData.length === 0) {
                showToast('No data to export.', 'error');
                return;
            }
            const delimiter = ';';
            const headers = tableHeaders.join(delimiter);
            const rows = filteredData.map(target => tableHeaders.map(header => {
                const value = target[header] !== undefined ? target[header] : '';
                const stringValue = String(value);
                return (stringValue.includes(delimiter) || stringValue.includes('"') || stringValue.includes('\n'))
                    ? `"${stringValue.replace(/"/g, '""')}"`
                    : stringValue;
            }).join(delimiter));

            const csvContent = [headers, ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'blackbox-targets.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        exportLink.addEventListener('click', (e) => {
            e.preventDefault();
            exportModal.style.display = 'block';
            if (filterRowsContainer.children.length === 0) {
                createFilterRow();
            }
            updatePreview();
        });
=======
            const filters = Array.from(filterRowsContainer.children).map(r => ({ field: r.querySelector('.filter-field').value, operator: r.querySelector('.filter-operator').value, value: r.querySelector('.filter-value').value })).filter(f => f.value);
            try {
                const response = await fetch('/api/export/preview', { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken}, body: JSON.stringify({ filters }) });
                if (!response.ok) throw new Error('Failed to fetch preview');
                filteredData = await response.json();
                renderPreviewTable();
            } catch (error) { showToast('Error fetching preview.', 'error'); }
        }

        function renderPreviewTable() {
            previewTableHead.innerHTML = `<tr>${tableHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
            previewTableBody.innerHTML = '';
            const dataToShow = filteredData.slice(0, parseInt(previewRowCountSelect.value, 10));
            if (dataToShow.length === 0) {
                previewTableBody.innerHTML = `<tr><td colspan="${tableHeaders.length}" style="text-align: center;">No matching targets.</td></tr>`;
                return;
            }
            dataToShow.forEach(target => {
                const row = document.createElement('tr');
                row.innerHTML = tableHeaders.map(h => `<td>${target[h] !== undefined ? target[h] : ''}</td>`).join('');
                previewTableBody.appendChild(row);
            });
        }

        function exportToCsv() {
            if (filteredData.length === 0) return showToast('No data to export.', 'error');
            const delimiter = ';';
            const headers = tableHeaders.join(delimiter);
            const rows = filteredData.map(target => tableHeaders.map(h => {
                const val = String(target[h] !== undefined ? target[h] : '');
                return val.includes(delimiter) || val.includes('"') ? `"${val.replace(/"/g, '""')}"` : val;
            }).join(delimiter));
            const csv = [headers, ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'blackbox-targets.csv';
            link.click();
        }

        exportLink.addEventListener('click', (e) => { e.preventDefault(); exportModal.style.display = 'block'; updatePreview(); });
>>>>>>> 53f13ebda89e6d6460280047d74ee3b7b91b3a8c
        closeExportModalBtn.addEventListener('click', () => { exportModal.style.display = 'none'; });
        addFilterBtn.addEventListener('click', createFilterRow);
        previewRowCountSelect.addEventListener('change', renderPreviewTable);
        exportCsvBtn.addEventListener('click', exportToCsv);

        // --- Idle Lockout Logic ---
        let idleTimer, warningTimer, countdownTimer;
        const idleTimeoutMinutes = {{ idle_timeout }};
        const idleWarningModal = document.getElementById('idleWarningModal');
        const stayLoggedInBtn = document.getElementById('stayLoggedInBtn');
        const countdownSpan = document.getElementById('idleWarningCountdown');

        function startIdleWarning() {
<<<<<<< HEAD
            let countdown = 60;
            countdownSpan.textContent = countdown;
            idleWarningModal.style.display = 'block';
            countdownTimer = setInterval(() => {
                countdown--;
                countdownSpan.textContent = countdown;
                if (countdown <= 0) logoutUser();
            }, 1000);
        }

        function logoutUser() {
            window.location.href = '/logout';
        }

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            clearTimeout(warningTimer);
            clearInterval(countdownTimer);
            idleWarningModal.style.display = 'none';
            const timeoutMs = idleTimeoutMinutes * 60 * 1000;
            warningTimer = setTimeout(startIdleWarning, timeoutMs - 60000);
            idleTimer = setTimeout(logoutUser, timeoutMs);
        }

        stayLoggedInBtn.addEventListener('click', resetIdleTimer);
        ['click', 'keypress'].forEach(evt => window.addEventListener(evt, resetIdleTimer));
        resetIdleTimer();

        // Make sure modals also close on outside click
        window.addEventListener('click', (event) => {
            if (event.target == exportModal) {
                exportModal.style.display = 'none';
            }
        });
=======
            let count = 60;
            countdownSpan.textContent = count;
            idleWarningModal.style.display = 'block';
            countdownTimer = setInterval(() => {
                count--;
                countdownSpan.textContent = count;
                if (count <= 0) window.location.href = '/logout';
            }, 1000);
        }

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            clearTimeout(warningTimer);
            clearInterval(countdownTimer);
            idleWarningModal.style.display = 'none';
            const timeoutMs = idleTimeoutMinutes * 60 * 1000;
            if (timeoutMs > 60000) {
                warningTimer = setTimeout(startIdleWarning, timeoutMs - 60000);
            }
            idleTimer = setTimeout(() => window.location.href = '/logout', timeoutMs);
        }

        stayLoggedInBtn.addEventListener('click', resetIdleTimer);
        ['click', 'keypress'].forEach(evt => window.addEventListener(evt, resetIdleTimer));
        resetIdleTimer();
        window.addEventListener('click', (event) => { if (event.target == exportModal) exportModal.style.display = 'none'; });
>>>>>>> 53f13ebda89e6d6460280047d74ee3b7b91b3a8c
    });
  </script>
</body>
</html>