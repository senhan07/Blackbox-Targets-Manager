<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>Blackbox Targets Manager</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .header {
      background-color: #fff;
      padding: 15px 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header-title {
      color: #007bff;
      margin: 0;
      font-size: 24px;
    }
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .header-button {
      background-color: #007bff;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }
    .header-button.generate { background-color: #28a745; }
    .header-button.primary { background-color: #007bff; }
    .header-button:hover { opacity: 0.9; }
    .button-danger { background-color: #dc3545 !important; }
    .button-danger:hover { background-color: #c82333 !important; }
    .user-dropdown { position: relative; display: inline-block; }
    .user-dropdown .user-button { display: flex; align-items: center; gap: 5px; }
    .dropdown-content { display: none; position: absolute; background-color: #f1f1f1; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; right: 0; border-radius: 5px; }
    .dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; }
    .dropdown-content a:hover { background-color: #ddd; }
    .dropdown-content.show { display: block; }
    .modal { display: none; position: fixed; z-index: 1100; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 1200px; position: relative; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { margin: 0; color: #007bff; }
    .close-modal { font-size: 24px; font-weight: bold; color: #666; cursor: pointer; border: none; background: none; padding: 0; }
    .close-modal:hover { color: #333; }
    .modal-body { margin-bottom: 20px; }
    .main-content { padding: 0 20px 80px; }
    table { width: 100%; border-collapse: collapse; background-color: #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); border-radius: 10px; overflow: hidden; }
    th, td { padding: 5px 5px; padding-left: 20px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background-color: #007bff; color: white; }
    .preview-section { margin-top: 20px; border-top: 1px solid #dee2e6; padding-top: 20px; }
    .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .preview-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
    .preview-table th, .preview-table td { padding: 8px; border: 1px solid #dee2e6; }
    .no-data-message { text-align: center; padding: 50px; color: #6c757d; font-size: 18px; }
    #idleWarningModal .modal-header { justify-content: center; }
    #idleWarningModal .modal-body { text-align: center; }
    #toastContainer { position: fixed; top: 20px; right: 20px; z-index: 1200; }
    .toast { background-color: #333; color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 10px; min-width: 250px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); animation: slideIn 0.5s ease-out; }
    .toast.error { background-color: #dc3545; }
    .toast.success { background-color: #28a745; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
  </style>
</head>
<body>
  <div id="toastContainer"></div>
  <div class="header">
    <h1 class="header-title">Blackbox Targets Manager</h1>
    <div class="header-actions">
      <div class="user-dropdown">
        <button class="header-button user-button"><i class="fas fa-user"></i> {{ username }} <i class="fas fa-caret-down"></i></button>
        <div class="dropdown-content">
            <a href="/settings" id="settingsLink">Settings</a>
            <a href="/users" id="userManagementLink">User Management</a>
            <a href="#" id="exportLink">Export</a>
        </div>
      </div>
      <a href="/logout" class="header-button button-danger" style="text-decoration: none;"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
  </div>

  <div class="main-content">
    <div id="noDataMessage" class="no-data-message" style="display: none;">No targets found.</div>
    <table id="targetsTable">
      <thead>
          <tr>
            <th>Prober</th><th>Target</th><th>Module</th><th>Zone</th><th>Service</th><th>Device</th><th>Connection Type</th><th>Location</th><th>Short Name</th><th>Status</th><th>Actions</th>
          </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Idle Timeout Warning Modal -->
  <div id="idleWarningModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">Session Timeout Warning</h2>
      </div>
      <div class="modal-body">
        <p>You will be logged out in <span id="idleWarningCountdown">60</span> seconds due to inactivity.</p>
        <p>Click the button below to stay logged in.</p>
      </div>
      <div class="modal-footer" style="text-align: center; margin-top: 20px;">
        <button id="stayLoggedInBtn" class="header-button generate">Stay Logged In</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Export Targets</h2>
        <button class="close-modal" id="closeExportModal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="filter-builder">
          <h4>Filters</h4>
          <div id="filter-rows"></div>
          <button id="addFilterBtn" class="header-button primary" style="margin-top: 10px;"><i class="fas fa-plus"></i> Add Filter</button>
        </div>
        <div class="preview-section">
          <div class="preview-header">
              <h4>Preview</h4>
              <div>
                  <span>Show:</span>
                  <select id="previewRowCount" style="margin-left: 5px;">
                      <option value="5">5</option><option value="10">10</option><option value="50">50</option><option value="100">100</option>
                  </select>
              </div>
          </div>
          <div style="overflow-x: auto;">
              <table id="exportPreviewTable" class="preview-table">
                  <thead></thead>
                  <tbody></tbody>
              </table>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="text-align: right; margin-top: 20px;">
        <button id="exportCsvBtn" class="header-button generate"><i class="fas fa-file-csv"></i> Export as CSV</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const userRole = '{{ user_role }}';
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.5s ease-out forwards';
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }

        const userDropdown = document.querySelector('.user-dropdown');
        userButton = userDropdown.querySelector('.user-button');
        dropdownContent = userDropdown.querySelector('.dropdown-content');
        userButton.addEventListener('click', (e) => { e.stopPropagation(); dropdownContent.classList.toggle('show'); });
        window.addEventListener('click', () => { if (dropdownContent.classList.contains('show')) dropdownContent.classList.remove('show'); });
        if (userRole !== 'admin') {
            ['settingsLink', 'userManagementLink'].forEach(id => {
                document.getElementById(id).addEventListener('click', (e) => {
                    e.preventDefault();
                    showToast('Access Denied: You do not have permission to view this page.', 'error');
                });
            });
        }

        const table = document.getElementById('targetsTable');
        const noDataMessage = document.getElementById('noDataMessage');
        const tbody = table.querySelector('tbody');
        async function loadTargets() {
            try {
                const response = await fetch('/targets');
                const targets = await response.json();
                tbody.innerHTML = '';
                if (targets.length === 0) {
                    table.style.display = 'none';
                    noDataMessage.style.display = 'block';
                } else {
                    table.style.display = 'table';
                    noDataMessage.style.display = 'none';
                }
            } catch (error) {
                table.style.display = 'none';
                noDataMessage.textContent = 'Error loading data.';
                noDataMessage.style.display = 'block';
            }
        }
        loadTargets();

        const exportModal = document.getElementById('exportModal');
        const exportLink = document.getElementById('exportLink');
        const closeExportModalBtn = document.getElementById('closeExportModal');
        const addFilterBtn = document.getElementById('addFilterBtn');
        const filterRowsContainer = document.getElementById('filter-rows');
        const previewRowCountSelect = document.getElementById('previewRowCount');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const previewTableHead = document.querySelector('#exportPreviewTable thead');
        const previewTableBody = document.querySelector('#exportPreviewTable tbody');
        const tableHeaders = ['address', 'instance', 'module', 'zone', 'service', 'device_type', 'connection_type', 'location', 'short_name', 'enabled'];
        let filteredData = [];

        function createFilterRow() {
            const row = document.createElement('div');
            row.className = 'filter-row';
            row.style.cssText = 'display:flex; gap:10px; margin-bottom:10px;';
            row.innerHTML = `<select class="filter-field">${tableHeaders.map(h => `<option value="${h}">${h}</option>`).join('')}</select><select class="filter-operator"><option>==</option><option>!=</option><option>~=</option></select><input type="text" class="filter-value" placeholder="Value"><button class="header-button button-danger"><i class="fas fa-trash"></i></button>`;
            row.querySelector('button').onclick = () => { row.remove(); updatePreview(); };
            row.querySelectorAll('select, input').forEach(el => {
                el.onchange = updatePreview;
                if(el.tagName === 'INPUT') el.oninput = updatePreview;
            });
            filterRowsContainer.appendChild(row);
        }

        async function updatePreview() {
            const filters = Array.from(filterRowsContainer.children).map(r => ({ field: r.querySelector('.filter-field').value, operator: r.querySelector('.filter-operator').value, value: r.querySelector('.filter-value').value })).filter(f => f.value);
            try {
                const response = await fetch('/api/export/preview', { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken}, body: JSON.stringify({ filters }) });
                if (!response.ok) throw new Error('Failed to fetch preview');
                filteredData = await response.json();
                renderPreviewTable();
            } catch (error) { showToast('Error fetching preview.', 'error'); }
        }

        function renderPreviewTable() {
            previewTableHead.innerHTML = `<tr>${tableHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
            previewTableBody.innerHTML = '';
            const dataToShow = filteredData.slice(0, parseInt(previewRowCountSelect.value, 10));
            if (dataToShow.length === 0) {
                previewTableBody.innerHTML = `<tr><td colspan="${tableHeaders.length}" style="text-align: center;">No matching targets.</td></tr>`;
                return;
            }
            dataToShow.forEach(target => {
                const row = document.createElement('tr');
                row.innerHTML = tableHeaders.map(h => `<td>${target[h] !== undefined ? target[h] : ''}</td>`).join('');
                previewTableBody.appendChild(row);
            });
        }

        function exportToCsv() {
            if (filteredData.length === 0) return showToast('No data to export.', 'error');
            const delimiter = ';';
            const headers = tableHeaders.join(delimiter);
            const rows = filteredData.map(target => tableHeaders.map(h => {
                const val = String(target[h] !== undefined ? target[h] : '');
                return val.includes(delimiter) || val.includes('"') ? `"${val.replace(/"/g, '""')}"` : val;
            }).join(delimiter));
            const csv = [headers, ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'blackbox-targets.csv';
            link.click();
        }

        exportLink.addEventListener('click', (e) => { e.preventDefault(); exportModal.style.display = 'block'; updatePreview(); });
        closeExportModalBtn.addEventListener('click', () => { exportModal.style.display = 'none'; });
        addFilterBtn.addEventListener('click', createFilterRow);
        previewRowCountSelect.addEventListener('change', renderPreviewTable);
        exportCsvBtn.addEventListener('click', exportToCsv);

        // --- Idle Lockout Logic ---
        let idleTimer, warningTimer, countdownTimer;
        const idleTimeoutMinutes = {{ idle_timeout }};
        const idleWarningModal = document.getElementById('idleWarningModal');
        const stayLoggedInBtn = document.getElementById('stayLoggedInBtn');
        const countdownSpan = document.getElementById('idleWarningCountdown');

        function startIdleWarning() {
            let count = 60;
            countdownSpan.textContent = count;
            idleWarningModal.style.display = 'block';
            countdownTimer = setInterval(() => {
                count--;
                countdownSpan.textContent = count;
                if (count <= 0) window.location.href = '/logout';
            }, 1000);
        }

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            clearTimeout(warningTimer);
            clearInterval(countdownTimer);
            idleWarningModal.style.display = 'none';
            const timeoutMs = idleTimeoutMinutes * 60 * 1000;
            if (timeoutMs > 60000) {
                warningTimer = setTimeout(startIdleWarning, timeoutMs - 60000);
            }
            idleTimer = setTimeout(() => window.location.href = '/logout', timeoutMs);
        }

        stayLoggedInBtn.addEventListener('click', resetIdleTimer);
        ['click', 'keypress'].forEach(evt => window.addEventListener(evt, resetIdleTimer));
        resetIdleTimer();
        window.addEventListener('click', (event) => { if (event.target == exportModal) exportModal.style.display = 'none'; });
    });
  </script>
</body>
</html>